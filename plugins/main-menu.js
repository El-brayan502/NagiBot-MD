import fetch from 'node-fetch'
import { xpRange } from '../lib/levelling.js'
import { promises as fsPromises } from 'fs'
import { join } from 'path'
import PhoneNumber from 'awesome-phonenumber'

let handler = async (m, { conn, usedPrefix, __dirname, participants }) => {
  try {
    await m.react('Рџй№ИЈ')

    let { exp, bank, registered } = global.db.data.users[m.sender]
    let name = await conn.getName(m.sender)
    let _uptime = process.uptime() * 1000
    let uptime = clockString(_uptime)
    let totalreg = Object.keys(global.db.data.users).length
    let groupUserCount = m.isGroup ? participants.length : '-'

    let perfil = await conn.profilePictureUrl(conn.user.jid, 'image')
      .catch(() => 'https://qu.ax/eBrxs.jpg')

    // Preparar el tag del usuario
    const userId = m.sender.split('@')[0]
    let taguser = `@${userId}`
    let phone = PhoneNumber('+' + userId)
    let pais = phone.getRegionCode() || 'Desconocido ­Ъїљ'

    const vids = [
        'https://n.uguu.se/hyMwbxeR.mp4',
      'https://n.uguu.se/hyMwbxeR.mp4',
      'https://n.uguu.se/hyMwbxeR.mp4'
    ]
    let videoUrl = vids[Math.floor(Math.random() * vids.length)]

    const header = [
      `РЋћРЋљРћЂРўЁРђб┬░*"'*┬░РђбРўЁРћЂРЋљРЋЌ`,
      `    Рюд ЖДЂ­Юљќ­Юљъ­ЮљЦ­Юљю­Юље­Юљд­ЮљъЖДѓ Рюд`,
      `РЋџРЋљРћЂРўЁРђб┬░*"'*┬░РђбРўЁРћЂРЋљРЋЮ`
    ].join('\n')

    const user = global.db.data.users[m.sender] || {};
    const country = user.country || '';
    const isPremium = user.premium || false;


    const channelRD = { 
      id: '120363312092804854@newsletter', 
      name: 'NagiBot Oficial channel'
    }


    const metaMsg = {
      quoted: global.fakeMetaMsg,
      contextInfo: {
        mentionedJid: [m.sender],
        isForwarded: true,
        forwardedNewsletterMessageInfo: {
          newsletterJid: channelRD.id,
          serverMessageId: 100,
          newsletterName: channelRD.name
        },
        externalAdReply: {
          title: '­ЮЉх­ЮЉе­ЮЉ«­ЮЉ░­ЮЉЕ­ЮЉХ­ЮЉ╗ ­ЮЉХ­ЮЉГ­ЮЉГ­ЮЉ░­ЮЉф­ЮЉ░­ЮЉе­ЮЉ│',
          body: '┬Е ­ЮЉЃ­ЮЉю­ЮЉц­ЮЉњ­ЮЉЪ­ЮЉњ­ЮЉЉ ­Юљх­ЮЉд ­Юљ╣­ЮЉј­ЮЉЏ­ЮЉА­ЮЉю­ЮЉџ!',
          mediaUrl: null,
          description: null,
          previewType: "PHOTO",
          thumbnailUrl: 'https://qu.ax/eBrxs.jpg',
          sourceUrl: 'https://whatsapp.com/channel/0029VbA877dDDmFSafT2xI42',
          mediaType: 1,
          renderLargerThumbnail: true
        }
      }
    }

    const body = `
  *­ЪЉц Hola* 
  ${taguser}

  *РЈ▒№ИЈ Uptime:*
  > ${uptime}

  *­ЪЉЦ En este chat:*
  > ${groupUserCount}

  *­Ъћљ Registrado:* 
  > ${registered ? 'РюЁ' : 'РЮї'}

  *сђљ­ЮЋи ­Юќј ­Юќў ­ЮќЎ ­Юќє - ­ЮЋ»­Юќі - ­ЮЋ« ­Юќћ ­Юќњ ­Юќє ­ЮќЊ ­ЮќЅ ­Юќћ ­ЮќўсђЉ*

  РћЈРћЂРћЂРЮЃ сђї ­Юљї­Юљъ­ЮљД­Юљ« ­ЮљЉ­Юљ▓­Юљ│­Юљъ­Юљї­ЮљЃ сђЇ РЮЃ
  РћЃ­Ъда .menu
  РћЃ­Ъда .runtime
  РћЃ­Ъда .admins
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­Юљѕ­ЮљД­ЮљЪ­Юље­ЮљФ­Юљд­Юљџ­Юљю­Юљб├│­ЮљД сђЇ РЮЃ
  РћЃ­Ъда .creador
  РћЃ­Ъда .dash
  РћЃ­Ъда .ds
  РћЃ­Ъда .status
  РћЃ­Ъда .horario
  РћЃ­Ъда .infobot
  РћЃ­Ъда .ping
  РћЃ­Ъда .reportar
  РћЃ­Ъда .sistema
  РћЃ­Ъда .speed
  РћЃ­Ъда .speedtest
  РћЃ­Ъда .donar
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­ЮљЉ­Юљъ­Юља­Юљб­Юљг­ЮљГ­ЮљФ­Юље сђЇ РЮЃ
  РћЃ­Ъда .unreg
  РћЃ­Ъда .marry
  РћЃ­Ъда .setgenre
  РћЃ­Ъда .delgenre
  РћЃ­Ъда .setbirth
  РћЃ­Ъда .delbirth
  РћЃ­Ъда .setdesc
  РћЃ­Ъда .deldesc
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­ЮљЃ­Юљб­Юљ»­Юљъ­ЮљФ­Юљг­Юљб├│­ЮљД сђЇ РЮЃ
  РћЃ­Ъда .consejo
  РћЃ­Ъда .divorce
  РћЃ­Ъда .doxear
  РћЃ­Ъда .parejas
  РћЃ­Ъда .pareja5
  РћЃ­Ъда .formartrio
  РћЃ­Ъда .iqtest
  РћЃ­Ъда .gay2
  РћЃ­Ъда .meme
  РћЃ­Ъда .morse
  РћЃ­Ъда .nombreninja
  РћЃ­Ъда .pajeame
  РћЃ­Ъда .personalidad
  РћЃ­Ъда .piropo
  РћЃ­Ъда .pokedex
  РћЃ­Ъда .pregunta
  РћЃ­Ъда .ship
  РћЃ­Ъда .top
  РћЃ­Ъда .zodiac
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­ЮљЅ­Юљ«­Юљъ­Юља­Юље­Юљг сђЇ РЮЃ
  РћЃ­Ъда .ttt
  РћЃ­Ъда .ahorcado
  РћЃ­Ъда .math
  РћЃ­Ъда .ppt
  РћЃ­Ъда .pvp
  РћЃ­Ъда .sopa
  РћЃ­Ъда .slot
  РћЃ­Ъда .cf
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­Юљё­Юљд­Юље­Юљ▒РђЉ­Юљђ­ЮљД­Юљб­Юљд­Юљъ сђЇ РЮЃ
  РћЃ­Ъда .angry
  РћЃ­Ъда .bath
  РћЃ­Ъда .bite
  РћЃ­Ъда .bleh
  РћЃ­Ъда .blush
  РћЃ­Ъда .bored
  РћЃ­Ъда .cafe
  РћЃ­Ъда .cry
  РћЃ­Ъда .cuddle
  РћЃ­Ъда .dance
  РћЃ­Ъда .drunk
  РћЃ­Ъда .eat
  РћЃ­Ъда .facepalm
  РћЃ­Ъда .happy
  РћЃ­Ъда .hello
  РћЃ­Ъда .hug
  РћЃ­Ъда .kill
  РћЃ­Ъда .kiss
  РћЃ­Ъда .kiss2
  РћЃ­Ъда .laugh
  РћЃ­Ъда .lick
  РћЃ­Ъда .love2
  РћЃ­Ъда .patt
  РћЃ­Ъда .poke
  РћЃ­Ъда .pout
  РћЃ­Ъда .preg
  РћЃ­Ъда .punch
  РћЃ­Ъда .run
  РћЃ­Ъда .sad
  РћЃ­Ъда .scared
  РћЃ­Ъда .seduce
  РћЃ­Ъда .shy
  РћЃ­Ъда .slap
  РћЃ­Ъда .sleep
  РћЃ­Ъда .smoke
  РћЃ­Ъда .think
  РћЃ­Ъда .undress
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­ЮљЉ­Юље­ЮљЦ­ЮљЦ­Юљ░­Юљџ­Юљб­ЮљЪ­Юљ«­Юљг сђЇ РЮЃ
  РћЃ­Ъда .rw
  РћЃ­Ъда .topws
  РћЃ­Ъда .claim
  РћЃ­Ъда .harem
  РћЃ­Ъда .regalar
  РћЃ­Ъда .vote
  РћЃ­Ъда .wvideo
  РћЃ­Ъда .wimage
  РћЃ­Ъда .winfo
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­Юљё­Юљю­Юље­ЮљД­Юље­Юљд­Юљб╠Ђ­Юљџ сђЇ РЮЃ
  РћЃ­Ъда .bank
  РћЃ­Ъда .crimen
  РћЃ­Ъда .depositar
  РћЃ­Ъда .minar
  РћЃ­Ъда .retirar
  РћЃ­Ъда .ruleta
  РћЃ­Ъда .trabajar
  РћЃ­Ъда .transfer
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­ЮљЉРђЉ­ЮљЈРђЉ­Юљє сђЇ РЮЃ
  РћЃ­Ъда .cofre
  РћЃ­Ъда .daily
  РћЃ­Ъда .cazar
  РћЃ­Ъда .halloween
  РћЃ­Ъда .heal
  РћЃ­Ъда .lb
  РћЃ­Ъда .inventario
  РћЃ­Ъда .mazmorra
  РћЃ­Ъда .monthly
  РћЃ­Ъда .weekly
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­Юљњ­Юљъ­ЮљФ­ЮљЏ­Юље­ЮљГ/­Юљѓ­Юље­ЮљЮ­Юљъ сђЇ РЮЃ
  РћЃ­Ъда .jadibot
  РћЃ­Ъда .deletebot
  РћЃ­Ъда .stop
  РћЃ­Ъда .serbot
  РћЃ­Ъда .serbot --code
  РћЃ­Ъда .token
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­ЮљЂ­Юљ«­Юљг­Юљю­Юљџ­ЮљЮ­Юље­ЮљФ­Юљъ­Юљг сђЇ РЮЃ
  РћЃ­Ъда .githubsearch
  РћЃ­Ъда .gnula
  РћЃ­Ъда .googlesearch
  РћЃ­Ъда .npmjs
  РћЃ­Ъда .tiktoksearch
  РћЃ­Ъда .wikis
  РћЃ­Ъда .xnxxsearch
  РћЃ­Ъда .ytsearch
  РћЃ­Ъда .imagen
  РћЃ­Ъда .stickergif
  РћЃ­Ъда .gif
  РћЃ­Ъда .getsticker
  РћЃ­Ъда .spotplay
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­ЮљЃ­Юљъ­Юљг­Юљю­Юљџ­ЮљФ­Юља­Юљџ­Юљг сђЇ РЮЃ
  РћЃ­Ъда .animedl
  РћЃ­Ъда .facebook
  РћЃ­Ъда .fb
  РћЃ­Ъда .gdrive
  РћЃ­Ъда .gitclone
  РћЃ­Ъда .instagram2
  РћЃ­Ъда .ig2
  РћЃ­Ъда .mangad
  РћЃ­Ъда .mediafire
  РћЃ­Ъда .mega
  РћЃ­Ъда .npmdl
  РћЃ­Ъда .aptoide
  РћЃ­Ъда .pinterest
  РћЃ­Ъда .play
  РћЃ­Ъда .tiktokrandom
  РћЃ­Ъда .tiktokimg
  РћЃ­Ъда .spotify
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­Юљђ­Юљб/­Юљѕ­Юљџ сђЇ РЮЃ
  РћЃ­Ъда .demo
  РћЃ­Ъда .gemini
  РћЃ­Ъда .ia
  РћЃ­Ъда .iapolli
  РћЃ­Ъда .gptpolli
  РћЃ­Ъда .gptpolli2
  РћЃ­Ъда .simi
  РћЃ­Ъда .flux
  РћЃ­Ъда .llama
  РћЃ­Ъда .genimg
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­Юљє­ЮљФ­Юљ«­ЮљЕ­Юље­Юљг сђЇ РЮЃ
  РћЃ­Ъда .warn
  РћЃ­Ъда .warns
  РћЃ­Ъда .delwarn
  РћЃ­Ъда .resetwarn
  РћЃ­Ъда .add
  РћЃ­Ъда .admins
  РћЃ­Ъда .delete
  РћЃ­Ъда .demote
  РћЃ­Ъда .encuesta
  РћЃ­Ъда .hidetag
  РћЃ­Ъда .infogrupo
  РћЃ­Ъда .kick
  РћЃ­Ъда .link
  РћЃ­Ъда .promote
  РћЃ­Ъда .revoke
  РћЃ­Ъда .setbye
  РћЃ­Ъда .Setdesc
  РћЃ­Ъда .setname
  РћЃ­Ъда .setwelcome
  РћЃ­Ъда .tagall
  РћЃ­Ъда .convocar
  РћЃ­Ъда .everyone
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­ЮљЄ­Юљъ­ЮљФ­ЮљФ­Юљџ­Юљд­Юљб­Юљъ­ЮљД­ЮљГ­Юљџ­Юљг сђЇ РЮЃ
  РћЃ­Ъда .cal
  РћЃ­Ъда .clima
  РћЃ­Ъда .fake
  РћЃ­Ъда .hd
  РћЃ­Ъда .readmore
  РћЃ­Ъда .spamwa
  РћЃ­Ъда .ssweb
  РћЃ­Ъда .tama├▒o
  РћЃ­Ъда .upmf
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­Юљѓ­Юље­ЮљД­Юљ»­Юљъ­ЮљФ­ЮљГ­Юљб­ЮљЮ­Юље­ЮљФ­Юљъ­Юљг ­ЮљЮ­Юљъ ­Юљђ­Юљ«­ЮљЮ­Юљб­Юље­Юљг сђЇРЮЃ
  РћЃ­Ъда .bass
  РћЃ­Ъда .blown
  РћЃ­Ъда .deep
  РћЃ­Ъда .earrape
  РћЃ­Ъда .fast
  РћЃ­Ъда .fat
  РћЃ­Ъда .nightcore
  РћЃ­Ъда .reverse
  РћЃ­Ъда .robot
  РћЃ­Ъда .slow
  РћЃ­Ъда .smooth
  РћЃ­Ъда .tupai
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­Юљѓ­Юље­ЮљД­Юљ»­Юљъ­ЮљФ­ЮљГ­Юљб­ЮљЮ­Юље­ЮљФ­Юљъ­Юљг сђЇ РЮЃ
  РћЃ­Ъда .ibb
  РћЃ­Ъда .togifaud
  РћЃ­Ъда .tourl
  РћЃ­Ъда .tourlAll
  РћЃ­Ъда .postimg
  РћЃ­Ъда .tovideo
  РћЃ­Ъда .tts
  РћЃ­Ъда .tts2
  РћЃ­Ъда .tts3
  РћЃ­Ъда .tourl2
  РћЃ­Ъда .niggafy
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРЮЃ сђї ­Юљњ­ЮљГ­Юљб­Юљю­Юљц­Юљъ­ЮљФ­Юљг сђЇ РЮЃ
  РћЃ­Ъда .emojimix
  РћЃ­Ъда .pfp
  РћЃ­Ъда .qc
  РћЃ­Ъда .sticker
  РћЃ­Ъда .toimg
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРфЕсђї ­Юљѓ­Юље­ЮљД­ЮљЪ­Юљб­Юља­Юљ«­ЮљФ­Юљџ­Юљю­Юљб├│­ЮљД сђЇРфе
  РћЃ­Ъда .autoadmin
  РћЃ­Ъда .banchat
  РћЃ­Ъда .banuser
  РћЃ­Ъда .grupocrear
  РћЃ­Ъда .join
  РћЃ­Ъда .unbanchat
  РћЃ­Ъда .unbanuser
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ

  РћЈРћЂРћЂРфЕсђї ­Юљѓ­ЮљФ­Юљъ­Юљџ­ЮљЮ­Юље­ЮљФ/­Юљј­Юљ░­ЮљД­Юљъ­ЮљФ сђЇРфе
  РћЃ­Ъда .reactch
  РћЃ­Ъда .listafk
  РћЃ­Ъда .expired
  РћЃ­Ъда .addyenes
  РћЃ­Ъда .addprem
  РћЃ­Ъда .copia
  РћЃ­Ъда .broadcast
  РћЃ­Ъда .bc
  РћЃ­Ъда .mgp
  РћЃ­Ъда .broadcastgroup
  РћЃ­Ъда .bcgc
  РћЃ­Ъда .bcgc2
  РћЃ­Ъда .cleanf┬Гiles
  РћЃ­Ъда .cleartmp
  РћЃ­Ъда .setcmd
  РћЃ­Ъда .deletefile
  РћЃ­Ъда .delexpired
  РћЃ­Ъда .delvn
  РћЃ­Ъда .delmsg
  РћЃ­Ъда .delimg
  РћЃ­Ъда .delsticker
  РћЃ­Ъда .delprem
  РћЃ­Ъда .reunion
  РћЃ­Ъда .removeowner
  РћЃ­Ъда .dsowner
  РћЃ­Ъда .fetch
  РћЃ­Ъда .getplugin
  РћЃ­Ъда .groups
  РћЃ­Ъда .grouplist
  РћЃ­Ъда .kickall
  РћЃ­Ъда .nuevabiobot
  РћЃ­Ъда .nuevafotobot
  РћЃ­Ъда .nuevonombrebot
  РћЃ­Ъда .prefix
  РћЃ­Ъда .resetpersonajes
  РћЃ­Ъда .resetprefix
  РћЃ­Ъда .restart
  РћЃ­Ъда .saveplugin
  РћЃ­Ъда .update
  РћЃ­Ъда .actualizar
  РћЃ­Ъда .quitarcoin
  РћЃ­Ъда .quitarbank
  РћЃ­Ъда .>*
  РћЃ­Ъда .=>*
  РћЌРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРфЕ
  `.trim()

    // Unir header + body
    const menu = `${header}\n${body}`

    // Configurar datos para el mensaje
    const botname = 'NagiBot Oficial channel'
    const textbot = 'NagiBot Oficial channel'
    const banner = perfil
    const redes = 'https://whatsapp.com/channel/0029VbA877dDDmFSafT2xI42'

    await conn.sendMessage(m.chat, {
      video: { url: videoUrl },
      caption: body,
      gifPlayback: true,
      mentions: [m.sender],  // Agregamos el array de menciones
      ...metaMsg
    })

  } catch (e) {
    console.error(e)
    await conn.sendMessage(m.chat, { 
      text: `Рюў Error al enviar el men├║: ${e.message}`,
      mentions: [m.sender]  // Tambi├Еn incluimos menciones en el mensaje de error
    }, { 
      quoted: metaMsg 
    })
  }
}

handler.help = ['menu']
handler.tags = ['main']
handler.command = ['menu','help','men├║','allmenu','menucompleto']
handler.register = true
export default handler

function clockString(ms) {
  const h = isNaN(ms) ? '--' : Math.floor(ms / 3600000)
  const m = isNaN(ms) ? '--' : Math.floor(ms / 60000) % 60
  const s = isNaN(ms) ? '--' : Math.floor(ms / 1000) % 60
  return [h, m, s].map(v => v.toString().padStart(2, '0')).join(':')
}